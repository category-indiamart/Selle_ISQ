WITH MY_PRODS AS
  (
  SELECT * FROM
  (
      SELECT 
        GLUSR_USR_ID, PC_ITEM_ID, ITEM_MAPPING_ISPRIME, FK_GLCAT_MCAT_ID, nvl(PC_ITEM_IS_ECOM,0) PC_ITEM_IS_ECOM,PC_ITEM_STATUS_APPROVAL,
        ROW_NUMBER() OVER(PARTITION BY PC_ITEM_ID ORDER BY ITEM_MAPPING_ISPRIME NULLS LAST) RN 
      FROM
          PC_ITEM_TO_GLCAT_MCAT MP,
          PC_ITEM P,
          GLUSR_USR,
          CUSTTYPE
      WHERE 
        PC_ITEM_ID = FK_PC_ITEM_ID(+)
        AND PC_ITEM_GLUSR_USR_ID in  ()
        AND GLUSR_USR_ID = PC_ITEM_GLUSR_USR_ID
        AND GLUSR_USR_CUSTTYPE_ID = CUSTTYPE_ID
        AND FK_GL_COUNTRY_ISO = 'IN'
		and PC_ITEM_STATUS_APPROVAL in (10,20,40,50)
  ) WHERE RN = 1
  ), MY_ISQS AS 
  (
  SELECT GLCAT_MCAT_ID, COUNT(IM_SPEC_MASTER_ID) NUM_QUESTIONS FROM 
  (
  select GLCAT_MCAT_ID , IM_SPEC_MASTER_ID, IM_SPEC_MASTER_DESC
  from im_cat_specification a, glcat_mcat b , IM_SPECIFICATION_MASTER
  where IM_CAT_SPEC_CATEGORY_ID = glcat_mcat_id and im_cat_spec_category_type =3 and im_cat_spec_status=1
  and FK_IM_SPEC_MASTER_ID = IM_SPEC_MASTER_ID
  and IM_CAT_SPEC_PRIORITY <> -1
  AND IM_SPEC_MASTER_BUYER_SELLER <> 1
  union
  select fk_glcat_mcat_id AS c, FK_IM_SPEC_MASTER_ID AS cnt_avail, IM_SPEC_MASTER_DESC
  from im_cat_specification, glcat_cat_to_mcat,IM_SPECIFICATION_MASTER,
  ( select im_cat_spec_category_id MCAT_EXCLUDE_ID from im_cat_specification where im_cat_spec_category_type =3 and im_cat_spec_status=1 )
  where im_cat_spec_category_type =2 and im_cat_spec_status=1
  and im_cat_spec_category_id = fk_glcat_cat_id
  and FK_IM_SPEC_MASTER_ID = IM_SPEC_MASTER_ID
  and fk_glcat_mcat_id = MCAT_EXCLUDE_ID(+)
  AND MCAT_EXCLUDE_ID IS NULL
  and IM_CAT_SPEC_PRIORITY not in (-1,49)
  AND IM_SPEC_MASTER_BUYER_SELLER <> 1
  ) GROUP BY GLCAT_MCAT_ID
  ), MY_FILLED_ISQS AS
  (
  SELECT 
    PC_ITEM_ATTRIBUTE.FK_PC_ITEM_ID,
    COUNT(DISTINCT DECODE(FK_IM_SPEC_MASTER_ID,-1,null,FK_IM_SPEC_MASTER_ID)) QUESTIONS_FILLED,
    COUNT(DISTINCT DECODE(FK_IM_SPEC_MASTER_ID,-1,PC_ITEM_ATTRIBUTE_ID)) CUSTOM_ISQ_FILLED
  FROM
    PC_ITEM_TO_GLCAT_MCAT MP,
    PC_ITEM P,
    GLUSR_USR,
    CUSTTYPE,
    PC_ITEM_ATTRIBUTE
  WHERE 
    PC_ITEM_ID = MP.FK_PC_ITEM_ID(+)
    AND PC_ITEM_ID = PC_ITEM_ATTRIBUTE.FK_PC_ITEM_ID
    AND PC_ITEM_GLUSR_USR_ID in  ()
    AND GLUSR_USR_ID = PC_ITEM_GLUSR_USR_ID
    AND GLUSR_USR_CUSTTYPE_ID = CUSTTYPE_ID
    AND FK_GL_COUNTRY_ISO = 'IN'
  GROUP BY PC_ITEM_ATTRIBUTE.FK_PC_ITEM_ID
  )
  select count(pc_item_id) TOTAL_PRODUCTS, COUNT(DECODE(NVL(NUM_QUESTIONS,0),0,NULL,1)) ITEMS_WITH_ISQ, 
  COUNT(DISTINCT FK_GLCAT_MCAT_ID) UNIQUE_MCATS,
  COUNT(DISTINCT DECODE(NVL(NUM_QUESTIONS,0),0,NULL,FK_GLCAT_MCAT_ID)) UNIQUE_MCATS_HAVING_ISQ, sum(NUM_QUESTIONS) NUM_QUESTIONS,
  sum(filled), sum(CUSTOM_ISQ_FILLED)
  from
  (
  SELECT FK_GLCAT_MCAT_ID, PC_ITEM_ID,NUM_QUESTIONS, (case when NUM_QUESTIONS = 0 or NUM_QUESTIONS is null then 0 else QUESTIONS_FILLED end) filled,CUSTOM_ISQ_FILLED 
  FROM MY_PRODS, MY_ISQS , MY_FILLED_ISQS
  WHERE FK_GLCAT_MCAT_ID = GLCAT_MCAT_ID(+)
  AND PC_ITEM_ID = FK_PC_ITEM_ID(+));
