WITH MY_PRODS AS
  (
  SELECT * FROM
  (
      SELECT 
        GLUSR_USR_ID, PC_ITEM_ID, ITEM_MAPPING_ISPRIME, FK_GLCAT_MCAT_ID, nvl(PC_ITEM_IS_ECOM,0) PC_ITEM_IS_ECOM,PC_ITEM_STATUS_APPROVAL,
        ROW_NUMBER() OVER(PARTITION BY PC_ITEM_ID ORDER BY ITEM_MAPPING_ISPRIME NULLS LAST) RN 
      FROM
          PC_ITEM_TO_GLCAT_MCAT MP,
          PC_ITEM P,
          GLUSR_USR,
          CUSTTYPE
      WHERE 
        PC_ITEM_ID = FK_PC_ITEM_ID(+)
        AND PC_ITEM_GLUSR_USR_ID in  ()
        AND GLUSR_USR_ID = PC_ITEM_GLUSR_USR_ID
        AND GLUSR_USR_CUSTTYPE_ID = CUSTTYPE_ID
        AND FK_GL_COUNTRY_ISO = 'IN'
        and PC_ITEM_STATUS_APPROVAL in (10,20,40,50)
		and IS_CATALOG =-1
  ) WHERE RN = 1
  ), MY_ISQS AS 
  (
   SELECT GLCAT_MCAT_ID,FK_PARENT_MCAT_ID PMCAT_ID, COUNT(distinct IM_SPEC_MASTER_ID) NUM_QUESTIONS, 
  COUNT(distinct CASE WHEN IM_CAT_SPEC_TYPE = 'K' OR IM_CAT_SPEC_TYPE = 'C' THEN IM_SPEC_MASTER_ID ELSE NULL END) NUM_QUESTIONS_KEY_CONFIG
  FROM 
  (
  select GLCAT_MCAT_ID ,IM_SPEC_MASTER_ID, IM_SPEC_MASTER_DESC,IM_CAT_SPEC_TYPE
  from im_cat_specification a, glcat_mcat b , IM_SPECIFICATION_MASTER
  where  glcat_mcat_id = IM_CAT_SPEC_CATEGORY_ID (+)
  and FK_IM_SPEC_MASTER_ID = IM_SPEC_MASTER_ID
  and IM_CAT_SPEC_PRIORITY <> -1
  AND IM_SPEC_MASTER_BUYER_SELLER <> 1
  AND im_cat_spec_category_type =3
  and IM_CAT_SPEC_STATUS =1
 --AND GLCAT_MCAT_ID =187935
  ) ,GLCAT_MCAT_TO_MCAT
  Where glcat_mcat_id = FK_CHILD_MCAT_ID (+)
  GROUP BY GLCAT_MCAT_ID,FK_PARENT_MCAT_ID
  ),MY_PMCAT_ISQS AS 
  (
  SELECT FK_CHILD_MCAT_ID,FK_PARENT_MCAT_ID, 
  COUNT(distinct CASE WHEN IM_CAT_SPEC_TYPE = 'K' OR IM_CAT_SPEC_TYPE = 'C' THEN IM_SPEC_MASTER_ID ELSE NULL END) NUM_QUESTIONS_KEY_CONFIG_PMCAT
  FROM 
  (
  select FK_CHILD_MCAT_ID ,FK_PARENT_MCAT_ID, IM_SPEC_MASTER_ID, IM_SPEC_MASTER_DESC,IM_CAT_SPEC_TYPE
  from im_cat_specification a, IM_SPECIFICATION_MASTER,GLCAT_MCAT_TO_MCAT
  where  im_cat_spec_category_type =3 and im_cat_spec_status=1
  and FK_IM_SPEC_MASTER_ID = IM_SPEC_MASTER_ID
  and IM_CAT_SPEC_PRIORITY <> -1
  AND IM_SPEC_MASTER_BUYER_SELLER <> 1
    and IM_CAT_SPEC_CATEGORY_ID = FK_PARENT_MCAT_ID
 --and (  IM_CAT_SPEC_TYPE = 'K' OR IM_CAT_SPEC_TYPE = 'C')
  --AND FK_CHILD_MCAT_ID =325219
  --and FK_PARENT_MCAT_ID = 2699
  ) 
  GROUP BY FK_CHILD_MCAT_ID,FK_PARENT_MCAT_ID
  ),
  MY_FILLED_ISQS AS
  (
  SELECT 
    A.FK_PC_ITEM_ID, 
    COUNT(DISTINCT DECODE(A.FK_IM_SPEC_MASTER_ID,-1,null,A.FK_IM_SPEC_MASTER_ID)) QUESTIONS_FILLED,
    COUNT(DISTINCT DECODE(A.FK_IM_SPEC_MASTER_ID,-1,PC_ITEM_ATTRIBUTE_ID)) CUSTOM_ISQ_FILLED,
    COUNT(DISTINCT case when (B.IM_CAT_SPEC_TYPE = 'K' or B.IM_CAT_SPEC_TYPE ='C') then IM_CAT_SPEC_ID else null end) KEY_CONFIG_ISQ_FILLED
  FROM
    PC_ITEM_TO_GLCAT_MCAT MP,
    PC_ITEM P,
	GLUSR_USR,
	CUSTTYPE,
    PC_ITEM_ATTRIBUTE A,
    IM_CAT_SPECIFICATION B
  WHERE 
    PC_ITEM_ID = MP.FK_PC_ITEM_ID(+)
    AND PC_ITEM_ID = A.FK_PC_ITEM_ID
    AND GLUSR_USR_ID = PC_ITEM_GLUSR_USR_ID
    AND GLUSR_USR_CUSTTYPE_ID = CUSTTYPE_ID
    AND FK_GL_COUNTRY_ISO = 'IN'
     and A.FK_IM_SPEC_MASTER_ID =B.FK_IM_SPEC_MASTER_ID (+)
	and IS_CATALOG =-1
  and GLUSR_USR_ID in ()
  GROUP BY  A.FK_PC_ITEM_ID
  )
   select sum(ToTAL_KEY_CONFIG_AVAIL) KEY_CONFIG_AVAIL,sum(KEY_CONFIG_ISQ_FILLED)
  from
  (
  select distinct PC_ITEM_ID,FK_GLCAT_MCAT_ID,PMCAT_ID,ToTAL_KEY_CONFIG_AVAIL,
(case when ToTAL_KEY_CONFIG_AVAIL is null then 0 else KEY_CONFIG_ISQ_FILLED end)KEY_CONFIG_ISQ_FILLED
from
(
  SELECT distinct PC_ITEM_ID,FK_GLCAT_MCAT_ID,PMCAT_ID,
  NUM_QUESTIONS,(NUM_QUESTIONS_KEY_CONFIG + NUM_QUESTIONS_KEY_CONFIG_PMCAT) ToTAL_KEY_CONFIG_AVAIL, (case when NUM_QUESTIONS = 0 or NUM_QUESTIONS is null then 0 else QUESTIONS_FILLED end) filled ,CUSTOM_ISQ_FILLED
  , KEY_CONFIG_ISQ_FILLED
  FROM MY_PRODS, MY_ISQS , MY_FILLED_ISQS, MY_PMCAT_ISQS
  WHERE FK_GLCAT_MCAT_ID = GLCAT_MCAT_ID(+)
  and PMCAT_ID = FK_PARENT_MCAT_ID (+)
  AND PC_ITEM_ID = FK_PC_ITEM_ID(+)
  ));

